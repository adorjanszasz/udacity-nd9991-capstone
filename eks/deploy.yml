---
- hosts: localhost
  gather_facts: false

  vars_files:
    - vars/main.yml

  tasks:
    - name: Deploy React-App.
      k8s:
        definition: "{{ item }}"
        kubeconfig: "{{ k8s_kubeconfig }}"
        state: present
      loop: "{{ lookup('template', 'react-app/main.yml') | from_yaml_all | list }}"

    - name: Get load balancer DNS name.
      k8s_info:
        kubeconfig: "{{ k8s_kubeconfig }}"
        kind: Service
        name: react-app
        namespace: default
      register: app_svc

    - name: Wait for Load Balancer to respond.
      uri:
        url: "http://{{ app_lb_host }}"
      register: lb_result
      until: lb_result.status == 200
      retries: 60
      delay: 5
      when: aws_environment | bool

    - name: Get ELB info.
      ec2_elb_info:
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        names: "{{ app_lb_host.split('-')[0] }}"
      register: elb_info
      when: aws_environment | bool

    - name: Add an A record in Route53 (if configured).
      route53:
        profile: "{{ aws_profile }}"
        zone: "{{ app_route53_zone }}"
        record: "{{ app_route53_domain }}"
        state: present
        type: A
        ttl: 300
        value: "{{ app_lb_host }}."
        alias: true
        alias_hosted_zone_id: "{{ elb_info['elbs'][0]['canonical_hosted_zone_name_id'] }}"
        wait: true
      when:
        - aws_environment | bool
        - app_route53_zone != ''
        - app_route53_domain != ''
